<?xml version="1.0" encoding="UTF-8"?>
<statements namespace="org.lsqt.syswin.uum.model.User" cache="true" import="org.lsqt.components.util.collection.ArrayUtil,org.lsqt.components.util.lang.StringUtil" >
	<table name="t_user_info">
			<column id="user_id" type="auto" property="userId" text="主键" />
	 	
	 		<column name="user_name" property="userName" text="用户名称（客户名称）"/>
	 	
	 		<column name="user_sex" property="sex" text="性别(1男2女)"/>
	 	
	 		<column name="nation" property="nation" text="民族"/>
	 	
	 		<column name="birthday" property="birthday" text="出生日期"/>
	 	
	 		<column name="work_no" property="workNo" text="用户名（默认手机号）"/>
	 	
	 		<column name="login_no" property="loginNo" text="账号"/>
	 	
	 		<column name="password" property="password" text="密码"/>
	 	
	 		<column name="pwd_salt" property="pwdSalt" text="加密盐值：8位随机数"/>
	 	
	 		<column name="mobile_phone" property="mobile" text="手机号(注册手机号)"/>
	 	
	 		<column name="user_phone" property="telephone" text="座机"/>
	 	
	 		<column name="user_email" property="email" text="邮箱"/>
	 	
	 		<column name="status" property="status" text="状态(1在职2试用期3离职)"/>
	 	
	 		<column name="employeeid" property="employeeId" text="employeeid"/>
	 	
	 		<column name="del_flag" property="delFlag" text="是否有效"/>
	 	
	 	
	 	
	 		<column name="createby" property="createUserId" text="创建者id"/>
	 		<column name="createby_name" property="createUserName" text="创建者名称"/>
	 		<column name="updateby" property="updateUserId" text="修改者id"/>
	 		<column name="updateby_name" property="updateUserName" text="修改者名称"/>
	 	
	 		<column updateTime="update_date" property="updateTime" text="修改时间"/>
	 		<column createTime="create_date" property="createTime" text="创建时间"/>
	 		
	</table>
	
	<statement id="queryForPage" parameterName="query">
	 	<![CDATA[
		 	select * from t_user_info where 1=1 
		 	<#if query??>
		 		<#-- -------------------关键字查询开始 --------------- -->
				<#if query.key??>
					<#assign key = StringUtil.escapeSql(query.key)/>
					and (
							user_name like '%${key}%'  or 
							nation like '%${key}%'  or 
							work_no like '%${key}%'  or 
							login_no like '%${key}%'  or 
							mobile_phone like '%${key}%'  or 
							user_phone like '%${key}%'  or 
							user_email like '%${key}%'  or 
							updateby_name like '%${key}%' or
							user_id = '${key}' 
							
					)
				</#if>
				
							<#if StringUtil.isNotBlank(query.ids)> and user_id in (${StringUtil.escapeSql(query.ids)}) </#if>
						
	  						<#if query.userId??> and user_id = ${query.userId} </#if>
					
	  						<#if query.userName??> and user_name like '%${StringUtil.escapeSql(query.userName)}%' </#if>
					
	  						<#if query.sex??> and user_sex = ${query.sex} </#if>
					
	  						<#if query.nation??> and nation = '${StringUtil.escapeSql(query.nation)}' </#if>
						
							<#if query.birthdayBegin?? && query.birthdayEnd??>
	  							and date_format(birthday,'%Y-%m-%d') between  '${StringUtil.escapeSql(query.birthdayBegin)}' and '${StringUtil.escapeSql(query.birthdayEnd)}'
	  						</#if>
	  						
	  						<#if query.workNo??> and work_no = '${StringUtil.escapeSql(query.workNo)}' </#if>
					
	  						<#if query.loginNo??> and login_no = '${StringUtil.escapeSql(query.loginNo)}' </#if>
					
					
							<#if query.loginNoList?? && (query.loginNoList?size > 0) > 
								and login_no in (
									<#list query.loginNoList as item>
									 	'${StringUtil.escapeSql(item)}' <#if item_has_next>,</#if>
									</#list>
								)
							</#if>
					
					
					
					
	  						<#if query.mobile??> and mobile_phone = '${StringUtil.escapeSql(query.mobile)}' </#if>
						
					
	  						<#if query.telephone??> and user_phone = '${StringUtil.escapeSql(query.telephone)}' </#if>
						
					
	  						<#if query.email??> and user_email = '${StringUtil.escapeSql(query.email)}' </#if>
						
	  						<#if query.status??> and status = ${query.status} </#if>
					
	  						<#if query.employeeId??> and employeeid = '${StringUtil.escapeSql(query.employeeId)}' </#if>
						
					
						
	  						<#if query.delFlag??> and del_flag = ${query.delFlag} </#if>
					
						
	  						<#if query.createUserId??> and createby = ${query.createUserId} </#if>
					
	  						<#if query.createUserName??> and createby_name = '${StringUtil.escapeSql(query.createUserName)}' </#if>
						
						
							<#if query.createTimeBegin?? && query.createTimeEnd??>
	  							and date_format(create_date,'%Y-%m-%d') between  '${StringUtil.escapeSql(query.createTimeBegin)}' and '${StringUtil.escapeSql(query.createTimeEnd)}'
	  						</#if>
	  						
						
	  						<#if query.updateUserId??> and updateby = ${query.updateUserId} </#if>
					
	  						<#if query.updateUserName??> and updateby_name = '${StringUtil.escapeSql(query.updateUserName)}' </#if>
						
					
							<#if query.updateDateBegin?? && query.updateDateEnd??>
	  							and date_format(update_date,'%Y-%m-%d') between  '${StringUtil.escapeSql(query.updateDateBegin)}' and '${StringUtil.escapeSql(query.updateDateEnd)}'
	  						</#if>
	  						
	  						<#-- 获取多个岗位下的用户 -->
	  						<#if StringUtil.isNotBlank(query.positionIds)>
	  							and  user_id in (select user_id from  t_user_duties where duties_id in (${StringUtil.escapeSql(query.positionIds)}))
	  						</#if>
	  						
	  						<#-- 获取多个部门下的用户(不包含子部门) -->
	  						<#if StringUtil.isNotBlank(query.orgIds)>
	  							and  user_id in (select user_id from  t_user_duties where duties_id in(select duties_id from T_ORG_DUTIES_INFO where org_unit_id in (${StringUtil.escapeSql(query.orgIds)})))
							</#if>	
							
							<#-- 获取某个角色下的用户 -->
							<#if StringUtil.isNotBlank(query.roleId)>
								and user_id in (
									select user_id from t_user_duties where duties_id in (
										SELECT duties_id FROM t_power_duties_role where role_id =  ${StringUtil.escapeSql(query.roleId)}  ))
							</#if>	
        	</#if>
        	
		]]>
	</statement>
	
	<statement id="getAll">
		<![CDATA[ select * from t_user_info ]]>
	</statement>
	
	<statement id="getTooManyMainPositionUsers">
		<![CDATA[ 
			<#-- 获取有多个主岗的用户  -->
			select * from t_user_info where user_id in (
				select user_id from (
					SELECT user_id,count(user_id) cnt FROM t_user_duties where duties_type=1 group by user_id having cnt >1) amount
			)
		]]>
	</statement>

	<statement id="getCompanyUsers" parameterName="args">
		<![CDATA[ 
			<#-- 获取分公司下的所有用户  -->
			select * from t_user_info where user_id in (
				SELECT A.user_id FROM t_user_duties A left join t_org_duties_info B on A.duties_id=B.duties_id where B.org_unit_id in (
					select org_unit_id from t_org_unit_info where org_node_path like '${StringUtil.escapeSql(args)}' 
			))
		]]>
	</statement>
</statements>
