<?xml version="1.0" encoding="UTF-8"?>
<statements namespace="org.lsqt.syswin.uum.model.Position" cache="true" import="org.lsqt.components.util.collection.ArrayUtil,org.lsqt.components.util.lang.StringUtil" >
	<table name="t_org_duties_info">
			<column id="duties_id" type="auto" property="id" text="主键" />
	 	
	 		<column name="duties_name" property="name" text="岗位名称"/>
	 	
	 		<column name="duties_code" property="code" text="岗位编码"/>
	 		
	 		<column name="remark" property="remark" text="岗位职责"/>
	 	
	 		<column name="direct_duties_id" property="pid" text="直属上级"/>
	 		
	 		<column name="node_path" property="nodePath" text="节点路径"/>
	 		
	 		<column name="direct_duties_name" property="parentName" text="直属上级名称"/>
	 	
	 		<column name="org_unit_level" property="type" text="岗位级别（1集团2区域公司3公司4管理项目5部门6工作组）"/>
	 	
	 		<column name="org_unit_id" property="orgId" text="当前岗位所属的组织"/>
	 	
	 		<column name="hr_id" property="uuidHR" text="HR系统的UUID"/>
	 		
	 		<column name="createby" property="createUserId" text="创建者id"/>
	 		<column name="createby_name" property="createUserName" text="创建者名称"/>
	 		<column name="updateby" property="updateUserId" text="修改者id"/>
	 		<column name="updateby_name" property="updateUserName" text="修改者名称"/>
	 	
	 		<column updateTime="update_date" property="updateTime" text="修改时间"/>
	 		<column createTime="create_date" property="createTime" text="创建时间"/>
	 	
	 		<column name="mainPositionDesc" property="mainPositionDesc" text="主岗兼岗文本值" isVirtual="true"/>
	</table>
	
	<statement id="queryForPage" parameterName="query">
	 	<![CDATA[
		 	select * from t_org_duties_info where 1=1
				 	<#if query??>
						<#if query.key??>
							<#assign key = StringUtil.escapeSql(query.key)/>
							and (
									duties_id = '${key}' or
									duties_name like '%${key}%'  or 
									remark like '%${key}%'  or 
									direct_duties_name like '%${key}%'  or 
									createby_name like '%${key}%'  or 
									updateby_name like '%${key}%' 
							)
						</#if>
				
						<#if query.ids??> and duties_id in (${StringUtil.escapeSql(query.ids)}) </#if>
						
	  					<#if query.id??> and duties_id = ${query.id} </#if>
					
	  					<#if query.name??> and duties_name = '${StringUtil.escapeSql(query.name)}' </#if>
						
						<#if query.nodePath??> and node_path like '${StringUtil.escapeSql(query.nodePath)}' </#if>
						
	  					<#if query.remark??> and remark = '${StringUtil.escapeSql(query.remark)}' </#if>
						
	  					<#if query.pid??> and direct_duties_id = ${query.pid} </#if>
					
	  					<#if query.parentName??> and direct_duties_name = '${StringUtil.escapeSql(query.parentName)}' </#if>
						
	  					<#if query.type??> and org_unit_level = ${query.type} </#if>
						
	  					<#if query.orgId??> and org_unit_id = ${query.orgId} </#if>
					
	  					<#if query.createUserId??> and createby = ${query.createUserId} </#if>
					
	  					<#if query.createUserName??> and createby_name = '${StringUtil.escapeSql(query.createUserName)}' </#if>
						
						<#if query.createTimeBegin?? && query.createTimeEnd??>
  							and date_format(create_date,'%Y-%m-%d') between  '${StringUtil.escapeSql(query.createTimeBegin)}' and '${StringUtil.escapeSql(query.createTimeEnd)}'
  						</#if>
	  						
	  					<#if query.updateUserId??> and updateby = ${query.updateUserId} </#if>
	  					
	  					<#-- 获取岗位上下级视图（没有pid的数据将不显示) -->
	  					<#if query.pidNotNull??> and direct_duties_id is not null or direct_duties_id != '' 
	  						or duties_id in (select direct_duties_id from t_org_duties_info where 1=1 and direct_duties_id is not null or direct_duties_id != '')
	  					</#if>
	  					
	  					<#if query.updateUserName??> and updateby_name = '${StringUtil.escapeSql(query.updateUserName)}' </#if>
						
						<#if query.updateTimeBegin?? && query.updateTimeEnd??>
  							and date_format(update_date,'%Y-%m-%d') between  '${StringUtil.escapeSql(query.updateTimeBegin)}' and '${StringUtil.escapeSql(query.updateTimeEnd)}'
  						</#if>
  						
  						<#-- 用户的岗位 -->
  						<#if query.userId??>
  							and duties_id in (select duties_id from  t_user_duties where user_id = ${query.userId}) 
  						</#if>
  						
  						<#-- 用于查询一堆用户的岗位 -->
  						<#if query.userIds?? && StringUtil.isNotBlank(query.userIds)>
  							and duties_id in (select duties_id from  t_user_duties where user_id in (${StringUtil.escapeSql(query.userIds)})) 
  						</#if>
  						
  						
  						<#-- 角色的岗位 -->
  						<#if query.roleId??>
  							and duties_id in (select duties_id from t_power_duties_role where role_id = ${query.roleId})
  						</#if>
  						
  						<#-- 查询某个岗位类别下的具体岗 -->
  						<#if query.positionCategoryId??>
  							and duties_id in (select duties_id from t_power_duties_type_mid where type_id = ${query.positionCategoryId}) 
  						</#if>
        	</#if>
        	
		]]>
	</statement>
	
	<statement id="getAll">
		<![CDATA[ select * from t_org_duties_info ]]>
	</statement>
	
	<statement id="getUserMainPosition" parameterName="args">
		<![CDATA[ 
			select * from t_org_duties_info where duties_id in (SELECT duties_id FROM t_user_duties where user_id= ${args} and duties_type=1)
		]]>
	</statement>
	
	
	<statement id="getMainPositionDescByUserId" parameterName="query">
	<![CDATA[ 
			select duties_id,
				case duties_type 
				when 1 then '主岗'
				when 2 then '兼岗'
			    end  as mainPositionDesc
			from t_user_duties where user_id = ${query.userId}  
	]]>
	</statement>
	
	<statement id="getTooManyMainPositionUsersForMap">
		<![CDATA[ 
		<#-- 获取有多个主岗的用户并能取到 "岗位用户"的第一条数据  （分组取第一条数据）select x, max(y) group by x  -->
		select user_id, min(pk) pk from (
			select A.pk,A.duties_id,A.user_id,A.duties_type from t_user_duties A left join t_org_duties_info B on A.duties_id=B.duties_id where A.user_id in (
					select user_id from (
					SELECT user_id,count(user_id) cnt FROM t_user_duties where duties_type=1 group by user_id having cnt >1
				) amount 
			) and duties_type = 1  and B.duties_id is not null order by user_id,duties_type  
		) temp_01 group by user_id  
		]]>
	</statement>
	
	<statement id="getConfigedPermitPosition" parameterName="query">
		<![CDATA[ 
		<#-- 获取已配置的权限岗位  -->
		select * from t_org_duties_info where duties_id in (
			select distinct(duties_id) from t_power_permit_duties_config where duties_id in (
				select duties_id from t_org_duties_info where 1=1 
						and duties_id in (SELECT duties_id FROM t_power_duties_role where role_id = ${query.roleId})
			)
		)
		]]>
	</statement>
</statements>
